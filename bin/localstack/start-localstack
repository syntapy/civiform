#!/bin/bash

# Begin localstack startup process
docker-compose -f bin/localstack/localstack.yaml up -d

# Wait until localhost:4566 is responsive
echo "Waiting for localstack to get set up. This may take a minute or two"
wget -O /tmp/localstack_health_check_slkhdfsg.html -o /tmp/localstack_health_check_slkhdfsg.log http://localhost:4566/health

# Wait until all services change from 'starting' to 'running'
HEALTHCHECK=$(</tmp/localstack_health_check_slkhdfsg.html)
while [[ $HEALTHCHECK == *"starting"* ]]
do
    sleep 2
    wget -O /tmp/localstack_health_check_slkhdfsg.html -o /tmp/localstack_health_check_slkhdfsg.log http://localhost:4566/health
    HEALTHCHECK=$(</tmp/localstack_health_check_slkhdfsg.html)
done

# Not needed anymore. Deletion here reduces (slight?) chance of wget write error on next 
# startup causing false indication that status has changed from 'starting' to 'running'
rm -f /tmp/localstack_health_check_slkhdfsg.html
rm -f /tmp/localstack_health_check_slkhdfsg.log

echo "Ensuring local s3 bucket exists"
bin/localstack/mk-s3
echo "Done"
